# Enhanced Dependency Review & Analysis
# Comprehensive dependency change analysis for pull requests
name: ðŸ“¦ Dependency Review Plus

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "package.json"
      - "package-lock.json"
      - "android/app/build.gradle"
      - "android/build.gradle"
      - "Dockerfile"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: read
  actions: read

jobs:
  dependency-review:
    name: ðŸ” Enhanced Dependency Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          check-latest: true
          cache: npm

      - name: GitHub Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical
          allow-licenses: "MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD"
          deny-licenses: "GPL-2.0, GPL-3.0"
          comment-summary-in-pr: true

      - name: Install current dependencies
        run: npm ci || npm install

      - name: Analyze dependency changes
        run: |
          echo "ðŸ“Š Analyzing dependency changes..."
          mkdir -p dependency-analysis
          git diff --name-only origin/${{ github.base_ref }}...HEAD > dependency-analysis/changed-files.txt
          if grep -q "package.json" dependency-analysis/changed-files.txt; then
            echo "ðŸ“ package.json has been modified"
            echo "## Package.json Changes" > dependency-analysis/package-changes.md
            echo "" >> dependency-analysis/package-changes.md
            echo "### Dependencies Diff" >> dependency-analysis/package-changes.md
            echo '```diff' >> dependency-analysis/package-changes.md
            git diff origin/${{ github.base_ref }}...HEAD package.json | head -100 >> dependency-analysis/package-changes.md || true
            echo '```' >> dependency-analysis/package-changes.md
            echo "" >> dependency-analysis/package-changes.md
          fi

      - name: Security audit on current state
        run: |
          echo "ðŸ”’ Running security audit on current dependencies..."
          npm audit --json > dependency-analysis/audit-current.json 2>/dev/null || echo "No audit output"
          npm audit > dependency-analysis/audit-current.txt 2>&1 || echo "Audit completed with findings"

          if [ -f "dependency-analysis/audit-current.json" ]; then
            echo "ðŸ“ˆ Security Analysis Results" > dependency-analysis/security-summary.md
            echo "=========================" >> dependency-analysis/security-summary.md
            echo "" >> dependency-analysis/security-summary.md
            node -e "
              try {
                const fs = require('fs');
                const audit = JSON.parse(fs.readFileSync('dependency-analysis/audit-current.json', 'utf8'));
                if (audit.vulnerabilities) {
                  const counts = { critical: 0, high: 0, moderate: 0, low: 0, info: 0 };
                  let totalVulns = 0;
                  Object.values(audit.vulnerabilities).forEach(vuln => {
                    if (vuln.severity) {
                      counts[vuln.severity] = (counts[vuln.severity] || 0) + 1;
                      totalVulns++;
                    }
                  });
                  console.log('### Current Vulnerability Status');
                  console.log('');
                  console.log('| Severity | Count |');
                  console.log('|----------|-------|');
                  console.log('| Critical | ' + counts.critical + ' |');
                  console.log('| High | ' + counts.high + ' |');
                  console.log('| Moderate | ' + counts.moderate + ' |');
                  console.log('| Low | ' + counts.low + ' |');
                  console.log('| Info | ' + counts.info + ' |');
                  console.log('| **Total** | **' + totalVulns + '** |');
                  if (totalVulns > 0) {
                    console.log('');
                    console.log('âš ï¸ **Action Required**: ' + totalVulns + ' vulnerabilities found');
                  } else {
                    console.log('');
                    console.log('âœ… **No vulnerabilities found**');
                  }
                } else {
                  console.log('âœ… No vulnerabilities detected');
                }
              } catch (error) {
                console.log('Error parsing audit results:', error.message);
              }
            " >> dependency-analysis/security-summary.md
          fi

      - name: Analyze bundle impact
        run: |
          echo "ðŸ“¦ Analyzing potential bundle size impact..."
          echo "### Bundle Analysis" > dependency-analysis/bundle-analysis.md
          echo "" >> dependency-analysis/bundle-analysis.md
          echo "**Dependency Count:**" >> dependency-analysis/bundle-analysis.md
          echo '```' >> dependency-analysis/bundle-analysis.md
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const deps = Object.keys(pkg.dependencies || {}).length;
            const devDeps = Object.keys(pkg.devDependencies || {}).length;
            console.log('Total dependencies:', deps);
            console.log('Development dependencies:', devDeps);
            console.log('Combined total:', deps + devDeps);
          " >> dependency-analysis/bundle-analysis.md
          echo '```' >> dependency-analysis/bundle-analysis.md

      - name: Check for known problematic packages
        run: |
          echo "âš ï¸ Checking for known problematic packages..."
          echo "### Package Risk Assessment" > dependency-analysis/risk-assessment.md
          echo "" >> dependency-analysis/risk-assessment.md
          RISKY_PACKAGES=("node-sass" "node-gyp" "fsevents" "sharp" "canvas" "puppeteer" "chromium" "playwright")
          DEPRECATED_PACKAGES=("request" "bower" "gulp" "grunt")
          echo "**Large/Complex Dependencies:**" >> dependency-analysis/risk-assessment.md
          for pkg in "${RISKY_PACKAGES[@]}"; do
            if grep -q "\"$pkg\"" package.json; then
              echo "- âš ï¸ $pkg (large/complex dependency)" >> dependency-analysis/risk-assessment.md
            fi
          done
          echo "" >> dependency-analysis/risk-assessment.md
          echo "**Deprecated Dependencies:**" >> dependency-analysis/risk-assessment.md
          for pkg in "${DEPRECATED_PACKAGES[@]}"; do
            if grep -q "\"$pkg\"" package.json; then
              echo "- âŒ $pkg (deprecated - consider alternatives)" >> dependency-analysis/risk-assessment.md
            fi
          done

      - name: Create comprehensive PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const readFileIfExists = (path) => {
              try { return fs.readFileSync(path, 'utf8'); } catch { return ''; }
            };
            const packageChanges = readFileIfExists('dependency-analysis/package-changes.md');
            const securitySummary = readFileIfExists('dependency-analysis/security-summary.md');
            const bundleAnalysis = readFileIfExists('dependency-analysis/bundle-analysis.md');
            const riskAssessment = readFileIfExists('dependency-analysis/risk-assessment.md');
            const licenseReport = readFileIfExists('dependency-analysis/license-report.md');
            const reportSections = [packageChanges, securitySummary, bundleAnalysis, riskAssessment, licenseReport].filter(section => section.trim().length > 0);
            const report = `## ðŸ“¦ Enhanced Dependency Review

            **PR Analysis Date:** ${new Date().toISOString()}
            **Base Branch:** ${context.payload.pull_request.base.ref}
            **Head Branch:** ${context.payload.pull_request.head.ref}

            ${reportSections.length > 0 ? reportSections.join('\n\n') : 'No significant dependency changes detected.'}

            ## ðŸ” Recommendations

            - **Security**: Review all security vulnerabilities and update affected packages
            - **Performance**: Monitor bundle size impact of new dependencies  
            - **Maintenance**: Prefer well-maintained packages with active development
            - **Licensing**: Ensure all new dependencies are compatible with project license

            ## ðŸ› ï¸ Next Steps

            1. Review the dependency changes above
            2. Run \`npm audit\` locally to verify security status
            3. Test the application with new dependencies
            4. Update documentation if needed

            ---

            *This analysis was generated automatically. For questions, check the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).*
            `;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existingComment = comments.find(comment => comment.user.type === 'Bot' && comment.body.includes('Enhanced Dependency Review'));
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: Upload dependency analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-analysis-${{ github.event.pull_request.number }}
          path: dependency-analysis/
          retention-days: 30

  # Check for dependency security in Android gradle files
  android-dependency-check:
    name: ðŸ¤– Android Dependencies
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'android/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Check Android dependencies
        run: |
          echo "ðŸ¤– Analyzing Android dependency changes..."
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.gradle$"; then
            echo "Gradle files have been modified:"
            git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.gradle$"
            echo "## Android Dependency Changes" > android-deps.md
            git diff origin/${{ github.base_ref }}...HEAD -- "*.gradle" > android-deps.md || true
          else
            echo "No Gradle file changes detected"
          fi

      - name: Comment Android changes
        if: hashFiles('android-deps.md') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changes = fs.readFileSync('android-deps.md', 'utf8');
            const comment = `## ðŸ¤– Android Dependency Changes

            Android Gradle files have been modified in this PR:

            \`\`\`diff
            ${changes}
            \`\`\`

            **Review checklist:**
            - [ ] Verify new dependencies are from trusted sources
            - [ ] Check for known security vulnerabilities in Android libraries
            - [ ] Test on physical device after changes
            - [ ] Verify app size impact
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
